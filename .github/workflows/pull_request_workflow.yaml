name: Publish Docker image

on:
  pull_request:
    types:
      - closed

jobs:
  push_to_registry:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_NAME: forum-backend
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Resolve app version (pom.xml)
        id: version
        shell: bash
        run: |
          VERSION="$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)"
          # Sanitiza para tag Docker (evita espaÃ§os/linhas)
          VERSION="$(echo "$VERSION" | tr -d '\r' | tr -d '\n' | xargs)"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "app_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build com Maven
        run: mvn clean package -DskipTests

      - name: Log in to Docker Hub
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image (versioned)
        run: docker build -f Dockerfile -t "$DOCKER_USERNAME/$IMAGE_NAME:$APP_VERSION" .

      - name: Push Docker image (versioned)
        run: docker push "$DOCKER_USERNAME/$IMAGE_NAME:$APP_VERSION"

      - name: Tag and push latest (optional)
        run: |
          docker tag "$DOCKER_USERNAME/$IMAGE_NAME:$APP_VERSION" "$DOCKER_USERNAME/$IMAGE_NAME:latest"
          docker push "$DOCKER_USERNAME/$IMAGE_NAME:latest"

  deploy_to_vps:
    needs: push_to_registry
    name: Deploy to VPS
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      IMAGE_NAME: forum-backend
      APP_VERSION: ${{ needs.push_to_registry.outputs.app_version }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Copy k8s manifests to VPS
        uses: appleboy/scp-action@917f8b81dfc1ccd331fef9e2d61bdc6c8be94634
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "k8s/*"
          target: "~/forum-k8s"
          strip_components: 1

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: DOCKER_USERNAME,IMAGE_NAME,APP_VERSION
          script: |
            set -e

            kubectl get namespace forum >/dev/null 2>&1 || kubectl create namespace forum

            kubectl apply -f ~/forum-k8s/secrets/db-credentials.yml

            kubectl apply -f ~/forum-k8s/postgres/postgres-pvc.yml
            kubectl apply -f ~/forum-k8s/postgres/postgres-deployment.yml
            kubectl apply -f ~/forum-k8s/postgres/postgres-service.yml

            kubectl wait --for=condition=ready pod -l app=postgres -n forum --timeout=120s

            kubectl apply -f ~/forum-k8s/app/app-deployment.yml
            kubectl apply -f ~/forum-k8s/app/app-service.yml
            kubectl apply -f ~/forum-k8s/app/app-ingressroute.yml

            kubectl set image deployment/forum-app-deployment forum-app="$DOCKER_USERNAME/$IMAGE_NAME:$APP_VERSION" -n forum

            kubectl rollout status deployment/forum-app-deployment -n forum --timeout=300s
      
